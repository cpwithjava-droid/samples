trigger:
  branches:
    include:
      - QA

pool:
  name: selfhosted-172

steps:
  # Checkout with credentials so push works
  - checkout: self
    persistCredentials: true

  # Merge QA into master (auto-resolve conflicts)
  - task: Bash@3
    displayName: 'Merge QA into master (auto-resolve conflicts)'
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

        echo "Fetching latest branches"
        git fetch origin

        echo "Checkout master"
        git checkout master
        git pull origin master

        echo "Merge QA into master (auto-resolve conflicts by taking QA)"
        git merge origin/QA -X theirs --no-ff --allow-unrelated-histories

        echo "Push to master"
        git push origin master

  # Run SonarQube analysis using Docker
  - task: Bash@3
    displayName: 'Run SonarQube Analysis via Docker Scanner'
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

        docker run --rm \
          -v "$(Build.SourcesDirectory)":/usr/src \
          sonarsource/sonar-scanner-cli:latest \
          -Dsonar.projectKey=Dontnet \
          -Dsonar.sources=/usr/src \
          -Dsonar.host.url="http://172.17.0.1:9000" \
          -Dsonar.login="$(SONAR_TOKEN)"

  # Install & Run ClamAV Scan
  - task: Bash@3
    displayName: 'Install & Run ClamAV Scan'
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

       
        clamscan -r "$(Build.SourcesDirectory)"
