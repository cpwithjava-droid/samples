trigger:
- main   # Trigger when code is pushed to main

pool:
  name: selfhosted-172

steps:
- checkout: self
  persistCredentials: true
  clean: true

- script: |
    set -e

    echo "Configuring Git..."
    git config user.email "cpwithjava@gmail.com"
    git config user.name "Azure DevOps Pipeline"

    echo "Fetching all branches..."
    git fetch origin

    echo "Checking out QA branch..."
    git checkout QA
    git reset --hard origin/QA

    echo "Merging main into QA, ignoring azure-pipelines.yml..."
    git merge origin/main --no-commit --no-ff --allow-unrelated-histories || true
    git checkout --ours azure-pipelines.yml
    git add azure-pipelines.yml

    # Only commit if there are changes
    if ! git diff-index --quiet HEAD --; then
        git commit -m "Merged main into QA (ignoring pipeline file)"
        echo "Pushing changes to QA..."
        git push origin QA
    else
        echo "Nothing to merge, QA already up to date with main"
    fi
  displayName: "Auto-merge main into QA (safe)"
