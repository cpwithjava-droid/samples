trigger:
  branches:
    include:
      - QA

pool:
  name: selfhosted-172

variables:
  REPORT_DIR: $(Build.ArtifactStagingDirectory)/clamav-report

steps:
  # Checkout with credentials
  - checkout: self
    persistCredentials: true

  # Merge QA into master
  - task: Bash@3
    displayName: 'Merge QA into master (auto-resolve conflicts)'
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

        git fetch origin
        git checkout master
        git pull origin master
        git merge origin/QA -X theirs --no-ff --allow-unrelated-histories
        git push origin master

  # Install & Run ClamAV Scan (report only)
  - task: Bash@3
    displayName: 'Install & Run ClamAV Scan (Generate Report)'
    inputs:
      targetType: inline
      script: |
        set -euo pipefail

        mkdir -p "$(REPORT_DIR)"

       
        clamscan -r "$(Build.SourcesDirectory)" \
          --log="$(REPORT_DIR)/clamav-report.log" \
          --infected

  # Publish ClamAV Report
  - task: PublishBuildArtifacts@1
    displayName: 'Publish ClamAV Report'
    inputs:
      PathtoPublish: '$(REPORT_DIR)'
      ArtifactName: 'clamav-report'
      publishLocation: 'Container'
